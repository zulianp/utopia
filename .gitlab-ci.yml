include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build_base
  - build # build stage is running on the Kubernetes cluster
  - test # test stage is running on PizDaint (on 1 node)

variables:
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/utopia:$CI_COMMIT_SHA

build-utopia-baseimage:
  extends: .container-builder
  stage: build_base
  before_script:
    - DOCKERFILE_TAG=`sha256sum $DOCKERFILE | head -c 16`
    - export PERSIST_IMAGE_NAME=$CSCS_REGISTRY_PATH/baseimage/utopia_base:$DOCKERFILE_TAG
    - echo "BASE_IMAGE=$PERSIST_IMAGE_NAME" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  variables:
    DOCKERFILE: utopia/docker/cscs_ci/Dockerfile.base

build-utopia:
  extends: .container-builder
  stage: build
  variables:
    DOCKERFILE: utopia/docker/cscs_ci/Dockerfile
    DOCKER_BUILD_ARGS: '["BASE_IMAGE=$BASE_IMAGE"]'
    GIT_SUBMODULE_STRATEGY: recursive

run-utopia-test:
  extends: .container-runner-daint-mc
  image: $PERSIST_IMAGE_NAME
  script:
    # the tests are not installed, so we need to run them from the build directory
    - cd /utopia.src/build
    - ./utopia_bench -verbose
