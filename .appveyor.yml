version: '{build}'
# clone_folder: c:\projects\sgrid

image: Visual Studio 2019

init:
  - ps: ($env:APPVEYOR_SAVE_CACHE_ON_ERROR = "true")


# cache dependencies libraries.
cache:



install:
# Install MS-MPI
- ps: Start-FileDownload 'https://github.com/microsoft/Microsoft-MPI/releases/download/v10.1.1/msmpisetup.exe'
- msmpisetup.exe -unattend
- set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%

# Install MS-MPI SDK
- ps: Start-FileDownload 'https://github.com/microsoft/Microsoft-MPI/releases/download/v10.1.1/msmpisdk.msi'
- msmpisdk.msi /quiet /passive
- set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%


# Install Blas/Lapack
- ps: Start-FileDownload 'http://netlib.org/lapack/lapack.tgz'
- 7z x lapack.tgz -so | 7z x -si -ttar > nul
- cd lapack-3.10.1

- ls C:\Program Files (x86)\Intel\SWTools\compilers_and_libraries_2019\windows\bin\intel64\

- IF NOT EXIST C:\projects\installations\lapack cmake -G "Visual Studio 16 2019" -A x64 -S . -B "build" -DCMAKE_INSTALL_PREFIX="C:\projects\installations\lapack" -DCMAKE_CXX_FLAGS="/W0 /EHsc" -DCMAKE_Fortran_COMPILER="C:\Program Files (x86)\Intel\SWTools\compilers_and_libraries_2019\windows\bin\intel64\ifort.exe" && cmake --build build --config Release --target install

# Other way with ninja
# - cmake -G "Ninja" -DCMAKE_BUILD_TYPE:STRING="Debug" -DCMAKE_INSTALL_PREFIX="C:\projects\installations\lapack" -DCMAKE_C_COMPILER:FILEPATH="C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64\cl.exe" -DCMAKE_MAKE_PROGRAM="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO\2019\COMMUNITY\COMMON7\IDE\COMMONEXTENTIONS\MICROSOFT\CMAKE\Ninja\ninja.exe" "C:\projects\lapack-3.10.1"

#Install Petsc
# Does not natively compile with windows
# Cannot use MS-MPI, Intel-MPI, MPICH2
# Options are, Cygwin to compile, MSYS, 
# - ps: Start-FileDownload 'https://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.18.3.tar.gz'
# - 7z x petsc-3.18.3.tar.gz -so | 7z x -si -ttar > nul
# - cd 





